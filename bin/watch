#! /usr/bin/env bash

# Watch the content folder and re-render the site when it changes.

# Depends on the fswatch program. Mostly exists so I don't have to remember
# fswatch syntax.

bin_dir="$(dirname "${BASH_SOURCE[0]}")"
project_dir="$(dirname "$bin_dir")"

. "$project_dir/virtualenv/bin/activate"

# The xargs invocation is a bit labored in order to output the timestamp of
# each re-rendering, and xargs doesn't have long option names, so some
# explanation is due.
#
# We execute a new bash instance for each line of input, then run the specified
# command in it.
#
# The first part of the command is double-quoted to interpolate the path to the
# script safely in the face of whitespace, while the second half is defined as
# a variable, so that it will not be interpolated by the current shell, which
# would result in the same timestamp for all items.
#
# Instead, it is interpolated by the new bash instance that is spawned by the
# new line of output from fswatch, and therefore gets a
# roughly-accurate timestamp.

# This is a literal string to be substituted in a later command, so I want
# literal dollar signs.
#
# shellcheck disable=SC2016
OUTPUT_DATE_CMD='echo $(date "+%Y-%m-%d %H:%M:%S"): Rendered site'

# At least on NixOS, fswatch seems to include file access time changes by
# default.
#
# We only care about actual changes to files, hence the --event options below.
fswatch \
    --event-flags --event Created --event Updated --event Removed --event Renamed \
    --recursive \
    --one-per-batch \
        "$project_dir/pages" \
        "$project_dir/templates" \
        "$project_dir/stylesheets" \
        "$bin_dir/generator.py" |
    xargs -L 1 bash -c "$bin_dir/generate && $OUTPUT_DATE_CMD"
